<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Delivery truck</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet'/>
    <style>
        body {margin: 0; padding: 0;}

        tr:nth-child(even) {background-color: #dddddd;}
        
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
        
        .truck {
            margin: -10px -10px;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            background: #3887be;
            cursor: pointer;
        }
        
        .button {
           background-color: #4CAF50;
           border: none;
           color: white;
           padding: 15px 135px;
           text-align: center;
           text-decoration: none;
           display: inline-block;
           font-size: 16px;
           margin: 4px 2px;
           cursor: pointer;
        }
        
        .back {
            font-family: arial;
            border-collapse: collapse;
            width: 100%;
            padding: 20px 40px; 
        }
        
        .mapboxgl-popup {max-width: 200px;}

        .mapboxgl-popup-content {
          text-align: center;
          font-family: 'Open Sans', sans-serif;
        }
        
        .map-overlay {
          position: absolute;
          bottom: 0;
          left: 0;
          background: rgba(255, 255, 255, 1.0);
          margin-left: auto;
          font-family: Arial, sans-serif;
          overflow: auto;
          border-radius: 3px;
        }

        #features {
          top: 0;
          height: 640px;
        }
        
        .previous {
            background-color: #f1f1f1;
            color: black;
        }
    </style>
</head>
<body>

    <div id='map' class='contain'> </div>
    <div class='map-overlay' id='features'>
    <div id='pd'></div></div>
    <script type="text/javascript">
        // *********************************************************************
        // TODO
        // *********************************************************************
        // - Every route should be its own layer(Right now the routes are sharing the same layer)
        // - When User is in HTMLTable UI all route should display.
        // - When selecting a specific route, all other route except the selected one should be hidden.(this will resolves the trouble of 
        //   making the problem redraw everything and calling the API more than it should)
        // - Solves problem with radius that creates popups with negative times.
        // - Add different color to each route. For visual aspect to let the user know which dropoff belong to each route.
        
        // *********************************************************************
        // Mapbox
        // *********************************************************************

        // Load initial map
        // *********************************************************************
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWNhYnJlcmEwNyIsImEiOiJjamlrYmppYWIyY2UzM2twZWJkdDJzdDlyIn0.7xKRaoS1MYm5N1edRqSBbQ';

        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v10', // stylesheet location
            center: [-66.700, 18.2208], // starting position
            zoom: 8.5 // starting zoom
        });

        // Navigation Control
        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'top-right');

        // *********************************************************************
        // Variable & Object Declaration
        // *********************************************************************

        // List which holds all the known dropoff locations on the map.
        var dropcoor = turf.featureCollection([]);
        var dropoffLocations= turf.featureCollection([]);
        var dropoffPopup = turf.featureCollection([]);
        var blank = turf.featureCollection([]);
        var popups= [];
        var trucks = [];
        var popuproute;
        var truckSelected;
        var HTML_Table = '<table>'
        var id=1;
        var Truck = function(_location, _maxLoad){
            this.id=id++;                       //id of truck
            this.location = _location;          //initial location of truck
            this.maxLoad = _maxLoad;            //maximum weight that truck can handle
            this.currentLoad = _maxLoad;        //current weight that truck is handling
            this.routeWeight = 0;               //time it takes the route to complete
            this.markedDropoff = turf.featureCollection([]);
            this.route=[];
            this.marker = document.createElement('div');
            this.marker.classList = 'truck';
            this.routeMile;
            this.routeColor= {'line-color':'#'+Math.floor(Math.random()*16777215).toString(16), 'line-width':4};;

            this.truckMarker = new mapboxgl.Marker(this.marker)
                                           .setLngLat(this.location)
                                           //.setPopup(new mapboxgl.Popup({ offset: 25 })
                                            //                     .setHTML('Max Load: '+this.maxLoad +'<br>' +'currentLoad: ' + this.currentLoad +'<br>'+'Route Duration: ' + Math.floor(this.routeWeight/60)+':'+(Math.floor(this.routeWeight%60)<10?'0':'')+Math.floor(this.routeWeight%60)+'</div> '))
                                           .addTo(map);

            this.updateLoad = load => {
                if((this.currentLoad - load) >= 0){
                    this.currentLoad = this.currentLoad - load;

                }
                else{
                    alert('Not enought load in truck');
                }
            };

            this.freeLoad= load =>{this.currentLoad= this.currentLoad + load;}

            this.updateRouteWeight = function(routeDurability){
                this.routeWeight = Math.round(routeDurability/60) //routeDurability will contain data.trips[0].duration which contains
                                                                  // the time expected in seconds
            }
        };

        // *********************************************************************
        // Functions Declaration
        // *********************************************************************
        
        // When Selecting a truck, this will be the menu that will display. It displays information about the route that was selected(soon directions of the route)
        function HTMLDirections(truck, id){
            var HTML_Directions = '';
            HTML_Directions += '<button style="display:inline-block;'
            HTML_Directions +=' vertical-align: middle;'
            HTML_Directions +=' margin:0px;'
            HTML_Directions +=' padding: 0;'
            HTML_Directions +=' border: none;'
            HTML_Directions +=' background: none;'
            HTML_Directions +=' font-size : 50px"'
            HTML_Directions +=' type="button" onclick="HTMLTable()" class="previous">&#8249; </button>'
            HTML_Directions +=' <h3 style="display:inline-block; vertical-align: middle; margin:0px 130px">  Route '+(id+1) +'</h3>' 
            HTML_Directions += '<div> Current Load: ' + truck.currentLoad + '</div>'      
            HTML_Directions += '<div> '+ 'ETA: '+Math.floor(truck.routeWeight/60)+':'          
            HTML_Directions +=                  (Math.floor(truck.routeWeight%60)<10?'0':'')
            HTML_Directions +=                   Math.floor(truck.routeWeight%60)+'</div> '
            HTML_Directions+=  '<div> Stops: ' + truck.markedDropoff.features.length + '</div>'
            document.getElementById('pd').innerHTML = HTML_Directions
        }
        
        // On the main menu of the ui, this HTML will be displayed
        function HTMLTable(){
            truckSelected=undefined;
            HTML_Table = '<table>'
             for(var i = 0; i < trucks.length ; i++){
                HTML_Table+='<tr>'
                HTML_Table+=    '<th rowspan="3" onclick="SelectTruck('+i+')">Route '+ (i+1) +'</th>'
                HTML_Table+=    '<td>Current Load: '+trucks[i].currentLoad+'</td>'
                HTML_Table+='</tr>'
                HTML_Table+='<tr>'
                HTML_Table+=    '<td>'
                HTML_Table+=        'ETA: '+Math.floor(trucks[i].routeWeight/60)+':'
                HTML_Table+=        (Math.floor(trucks[i].routeWeight%60)<10?'0':'')
                HTML_Table+=        Math.floor(trucks[i].routeWeight%60) 
                HTML_Table+=    '</td>'
                HTML_Table+='</tr>'
                HTML_Table+='<tr>'
                HTML_Table+=    '<td>Stops: '+ trucks[i].markedDropoff.features.length +'</td>'
                HTML_Table+='</tr>'
            }
            HTML_Table += '</table>'
            HTML_Table += '<button class="button" type="button" onClick="AddRoute()">Add Route</button>'
            document.getElementById('pd').innerHTML = HTML_Table
            trucks.forEach(truck => {
                truck.truckMarker.addTo(map)
            })
            if(trucks.length!=0){allRoute()};
        }

        // This function will get the markedDropoff variable and feed it to the optimization API which will return
        // the optimized route for the truck.
        function getRouteMarked(route, truck){

            var destinations = [];
            route.features.forEach(Geometry => {
                destinations.push(Geometry.geometry.coordinates);
             });
            return 'https://api.mapbox.com/optimized-trips/v1/mapbox/driving/' + truck.location[0] + ',' + truck.location[1] + ';'
                    + destinations.join(';') + '?overview=full&steps=true&geometries=geojson&source=first&access_token='
                    + mapboxgl.accessToken;
        };
        
        // This functions creates the URL to updates the dropoff locations with the time that will take to be added to the route.
        function getRouteWeight(route, truck){

            var destinations = [];
            route.forEach(function(Geometry){
                destinations.push(Geometry.geometry.coordinates);
             });
            return 'https://api.mapbox.com/optimized-trips/v1/mapbox/driving/' + truck.location[0] + ',' + truck.location[1] + ';'
                    + destinations.join(';') + '?overview=full&steps=true&geometries=geojson&source=first&access_token='
                    + mapboxgl.accessToken;
        };

        // This function will get the information returned from the getRoute and use it to draw the optimized
        // truck route on the map.
        function drawRoute(truck){
            fetch(getRouteMarked(truck.markedDropoff, truck))
            .then(res => {
                return res.json()
            })
            .then(data => {
                var route = (data.trips[0].geometry);
                truck.route= route;
                truck.routeMile= data.trips[0].distance/1609.344;
                truck.updateRouteWeight(data.trips[0].duration);
                map.getSource('route'+truck.id).setData(truck.route);
                
            })
            .then(nothing => {
               
                var id;
                for(var i =0; i< trucks.length;i++){
                    if(trucks[i]==truckSelected){
                        var id = i
                    }
                }
                HTMLDirections(truck, id)
                
            })
        };

        function allRoute(){
            trucks.forEach(truck => {map.getSource('route'+truck.id).setData(truck.markedDropoff)});
            map.getSource('dropoffs-symbol').setData(dropoffLocations);
        }
        
        // This functions calls the optimization api to calculate the time that will add to each dropoff 
        function updateTruckWeight(drop, truck){
            var copyMarked = truck.markedDropoff.features.slice(0);
            copyMarked.push(drop)
            fetch(getRouteWeight(copyMarked, truck))
            .then(res =>{
                return res.json();
            })
            .then(data =>{
                var newWeight = Math.round(data.trips[0].duration/60) - truck.routeWeight;
                drop.properties.weight = newWeight;
                drop.properties.color = colorCalculator(drop.properties)
                return drop
            })
            .then(feature =>{

                createPopup(feature);
                dropoffLocations.features.forEach(function(dropoff){
                    if(dropoff.properties.name == feature.properties.name){
                        dropoff.properties.weight = feature.properties.weight
                    }
                map.getSource('dropoffs-symbol').setData(dropoffLocations)
                })
            })
        };

        // Function that is called when the Add Route Button is added. For now it adds a marker to the 
        // map within a bounding box. and create a truck object.
        function AddRoute(){
            var x= getRndFloat(-67.13664550786771, -65.70716270963167);
            var y= getRndFloat(17.986497494385915, 18.45869548139244);
            var tmp= new Truck([x, y], Math.floor(Math.random() * (100 - 10) ) + 10);
            trucks.push(tmp);
            map.addLayer({
              id:'route'+tmp.id,
              type: 'line',
              source:{data: blank,type: 'geojson'},
              paint: tmp.routeColor
            }, 'dropoffs-symbol');
            HTMLTable()
        }
        
        function SelectTruck(id){
            trucks.forEach(truck => {
                truck.truckMarker.remove()
            })
            truckSelected = trucks[id]
            truckSelected.truckMarker.addTo(map)
            // console.log(truckSelected);
            HTMLDirections(truckSelected, id)
        }
        // Display automatically the popups of the dropoff within the Radius
        function Radius(_x, _y, truck){

            var centerPoint = {radius:0.16093, x:_x, y:_y}
            dropoffLocations.features.forEach(point =>{
                var pointLocation = {radius: 0.00001, x:point.geometry.coordinates[0], y:point.geometry.coordinates[1]}
                var dx = centerPoint.x - pointLocation.x;
                var dy = centerPoint.y - pointLocation.y;
                if(Math.sqrt(dx*dx + dy*dy) < centerPoint.radius){
                    dropoffPopup.features.push(point)
                    new updateTruckWeight(point, truck)
                }
            })
        };

        // if feature.weight == -1 || feature.weight < dropoff.weight
        // Creates a popup for every dropoff in dropoffLocations.
        function createPopup(feature){
            html= ''
            html+= feature.properties.load+' palletes<br>'
            html+= '<svg height=15 width=20 xmlns="http://www.w3.org/2000/svg" version="1.1">'
            html+= '<circle cx="10" cy="10" r="5" fill="'+feature.properties.color+'"/></svg>'
            html+= '+'+feature.properties.weight+ ' min'
            var popup = new mapboxgl.Popup({ offset: [0, 0], closeButton:false})
                //.setLngLat(feature.geometry.coordinates)
                .setHTML(html)
                .setLngLat(feature.geometry.coordinates)
                .addTo(map);
        };

        // This function when given a point, it will check its weight(minutes it takes to drive to the point),
        // and assign it a color depending on its weight. red if the weight is greater than 20, yellow
        // if its between 10 and 19, and green if its less or equal than 10.
        function colorCalculator(dropoff){
            if(dropoff.weight >= 20){
                return '#ff0000';
            }
            else if(dropoff.weight >= 10){
                return '#ffff00';
            }
            else if(dropoff.weight >= 0){
                return '#00ff00';
            }
        };

        // Returns an integer between min(included) & max(excluded)
        function getRndInteger(min, max) {
            return Math.floor(Math.random() * (max - min) ) + min;
        };

        // Returns a float between min(included) & max(excluded)
        function getRndFloat(min, max) {
            return Math.random() * (max - min)  + min;
        };

        // Empty list which will hold all the dropoff locations that were marked on the map.
        for (var i=0; i<50; i++){
            x= getRndFloat(-67.13664550786771, -65.70716270963167)
            y= getRndFloat(17.986497494385915, 18.45869548139244)
            l= getRndInteger(1, 10);
            dropoffLocations.features.push(turf.point([x, y],{name: i, load: l, weight: -1, ppop:false}));
        }

        function animate(truck){
            var route= truck.APIData.trips[0].geometry
            var start= route.coordinates[0];
            var j=0;

            var tm = document.createElement('div');
            tm.classList = 'truck';

            marker= new mapboxgl.Marker()
                .setLngLat(start)
                .addTo(map);

            tick(route, marker, j);
        }

        function tick(route, marker, j){
            marker.remove()
                .setLngLat(route.coordinates[j])
                .addTo(map);
            if (j<route.coordinates.length) {setTimeout(function(){tick( route, marker,j+1)},100)};
        }


        // *********************************************************************
        // Mapbox
        // *********************************************************************
        // Map Layers
        map.on('load', function(){

            // Adds layer with all dropoff locations.
            map.addLayer({
              id: 'dropoffs-symbol',
              type: 'symbol',
              source: {data: dropoffLocations,type: 'geojson'},
              layout: {
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-image': 'square-15',
              }
            });

            // Adds layer with all marked dropoff locations.
            map.addLayer({
              id: 'marked-dropoff',
              type: 'symbol',
              source: {data: blank,type: 'geojson'}, // Think of how to display all MarkedDropoff. prob function with an array of all truck
              layout: {
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-image': 'circle-15',
              }
            });
        });
        HTMLTable();

        // *********************************************************************
        // Events/Listeners
        
        // when the clicks on the map, checks if a marker was clicked and if true,
        // then change that marker from unmarked to marked or vice-versa.
        map.on('click',e =>{
            // returns the info of the clicked dropoff marker on map.
            var pt = map.queryRenderedFeatures(e.point, {layers: ['dropoffs-symbol', 'marked-dropoff']});

            // if a marker is clicked, do the following
            if (pt.length){
                if(trucks.length==0){alert('Please first add a route.')}
                else if(truckSelected == undefined){alert('Please select a route before adding a dropoff.')}
                
                // if the marker is unmarked, do the following
                else if(pt[0].layer.id=='dropoffs-symbol'){
                    // looks for the clicked marker in dropoffLocations.
                    for(var i = 0; i < dropoffLocations.features.length; i++){
                        // if the clicked marker is found, do the following.
                        if(pt[0].properties.name == dropoffLocations.features[i].properties.name){
                            // push the dropoff to markedDropoff.
                            truckSelected.markedDropoff.features.push(dropoffLocations.features[i]);
                            // update the truck load.
                            truckSelected.updateLoad(dropoffLocations.features[i].properties.load);
                            // remove the dropoff from dropoffLocation, do to it now being marked.
                            // dropoffLocations.features.splice(i, 1);
                            break;
                        }
                        dropoffLocations.features[i].properties.weight = -1;
                    }
                }

                // if the marker is marked, do the following
                else{
                    // look the marker in markedDropoff of truckSelected
                    for(var i=0; i<truckSelected.markedDropoff.features.length; i++){
                        // if found, do the following
                        if(pt[0].properties.name == truckSelected.markedDropoff.features[i].properties.name){
                            // check if marked is already in dropoffLocations.
                            var check=0;
                            for(var j=0; j<dropoffLocations.features.length; j++){
                                if(pt[0].properties.name == dropoffLocations.features[j].properties.name){
                                    check=1;
                                    break;
                                }
                            }

                            // if the marked is not in dropoffLocations, then add it
                            if(check==0){dropoffLocations.features.push(pt[0])};

                            // update truckSelected
                            truckSelected.freeLoad(pt[0].properties.load);

                            // remove the dropoff from truckSelected.markedDropoff
                            truckSelected.markedDropoff.features.splice(i, 1);
                            break;
                        }
                    }
                }
            }

            // if marker not clicked, change ppop of dropoffLocations to false.
            else{
                for (var i=0; i< dropoffLocations.features.length; i++){
                    dropoffLocations.features[i].properties.ppop=false;
                }
            }


            // draw the truck route.
            // if (truckSelected.markedDropoff.features.length==0){
            //     map.getSource('route').setData(blank);
            //     // truckSelected.markedDropoff = turf.featureCollection([]);
            // }


            // update the sources of the layers: 'dropoffs-symbol' & 'marked-dropoff'.
            map.getSource('dropoffs-symbol').setData(dropoffLocations);

            if(truckSelected!=undefined){
                map.getSource('marked-dropoff').setData(truckSelected.markedDropoff);
                drawRoute(truckSelected);

                //update the weight of the dropoff points in dropoffLocations.
                dropcoor.features.length = 0

                dropcoor.features.push(turf.point([truckSelected.location[0], truckSelected.location[1]]))
                truckSelected.markedDropoff.features.forEach(mark => {
                     dropcoor.features.push(turf.point(mark.geometry.coordinates))
                })
                var center = turf.center(dropcoor)
                Radius(center.geometry.coordinates[0], center.geometry.coordinates[1], truckSelected);
            }
        });

        // when the cursor is hovering over the marker, it will change the cursor icon
        // from the grab icon to the pointer icon & create a popup for the dropoff marker.
        map.on('mouseover', 'dropoffs-symbol', e=> {
            var features = map.queryRenderedFeatures(e.point, {layers: ['dropoffs-symbol']});
            // if cursor hovers an unmarked dropoff, do the following
            if (features.length && truckSelected!=undefined) {

                map.getCanvas().style.cursor='pointer'; // change cursor icon from grab to pointer
                
                feature=features[0];

                // if weight of dropoff is undefined, update it
                if(feature.properties.weight == -1){
                    updateTruckWeight(feature, truckSelected);
                }

                // if the dropoff does not have a popup, do the following
                else if(feature.properties.ppop == false){
                    feature.properties.color= colorCalculator(feature.properties) // update color of dropoff
                    createPopup(feature);   //create popup for dropoff
                    feature.properties.ppop=true; //change ppop of dropoff

                    // update dropoff in dropoffLocations
                    for (var i=0; i<dropoffLocations.features.length; i++){
                        if(feature.properties.name==dropoffLocations.features[i].properties.name){
                            dropoffLocations.features[i]= feature;
                            break
                        }
                    }

                    // update source of the layer 'dropoffs-symbol'.
                    map.getSource('dropoffs-symbol').setData(dropoffLocations);
                }
            }
            else if(features.length){map.getCanvas().style.cursor='pointer'};
        });

        // when the cursor is hovering over the marker, it will change the cursor icon
        // from the grab icon to the pointer icon.
        map.on('mouseover', 'marked-dropoff' , e=>{
            features= map.queryRenderedFeatures(e.point, {layers:['marked-dropoff']});
            if(features.length && truckSelected != undefined){map.getCanvas().style.cursor='pointer'};
        })

        // when the cursor leaves the marker, change cursor icon from the pointer icon 
        // to the grab icon.
        map.on('mouseleave','dropoffs-symbol', e=> {map.getCanvas().style.cursor=''});
        
        // when the cursor leaves the marker, change cursor icon from the pointer icon 
        // to the grab icon.
        map.on('mouseleave','marked-dropoff' , e=> {map.getCanvas().style.cursor=''});

        // when the cursor is hovering over the route, display a popup with
        // the time it takes the truck to finish the route.
        map.on('mouseover', 'route', e => {

            // check is cursor is hovering over route
            var routeLocation =  map.queryRenderedFeatures(e.point, {layers: ['route']});

            // if hovering on route, create route popup
            if (routeLocation.length){
                var pophtml = ''
                pophtml+= 'Current Route Duration<br>'
                pophtml+= truckSelected.routeWeight+ ' min' //Think of how to get the correct truck of the route selected.
                popuproute = new mapboxgl.Popup({ offset: [0, -15], closeButton:false})
                    .setLngLat(e.lngLat)
                    .setHTML(pophtml)
                    .addTo(map);
            }
        });

        // when the cursor leaves the route, removes route popup.
        map.on('mouseleave', 'route', e => {popuproute.remove()});
    </script>
</body>
</html>