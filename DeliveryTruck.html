<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Delivery truck</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet'/>
    <style>
      
        body {margin: 0; padding: 0;}
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
      }
        .truck {
            margin: -10px -10px;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            background: #3887be;
            pointer-events: none;
        }

    </style>
</head>

<body>
    <div id='map' class='contain'> </div>
    <script type="text/javascript">

        // *********************************************************************
        // Mapbox 
        // *********************************************************************
        
        // Load initial map
        // *********************************************************************
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2x5NDcxIiwiYSI6ImNqaWthMGZ0dzBpemwza21qM3BscTV5ZXcifQ.bdNLupProYoMvqdmNOpl-A';

        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v10', // stylesheet location
            center: [-66.4500, 18.2208], // starting position
            zoom: 9 // starting zoom
        });

        // Navigation Control
        var nav = new mapboxgl.NavigationControl();
        map.addControl(nav, 'top-right');
       
        // *********************************************************************
        // Functions Declaration
        // *********************************************************************

        // This function when given a point, it will check its weight(minutes it takes to drive to the point),
        // and assign it a color depending on its weight. red if the weight is greater than 20, yellow
        // if its between 10 and 19, and green if its less or equal than 10.
        function colorCalculator(dropoff){
            if(dropoff.weight >= 20){
                return '#ff0000';
            }
            else if(dropoff.weight >= 10){
                return '#ffff00';
            }
            else if(dropoff.weight >= 0){
                return '#00ff00';
            }
        }; 
        
        // This function will get the markedDropoff variable and feed it to the optimization APi which will return
        // us the the optimized route for the truck.
        function getRouteMarked(route){

            var destinations = [];
            route.features.forEach(function(Geometry){
                destinations.push(Geometry.geometry.coordinates); 
             }); 
            return 'https://api.mapbox.com/optimized-trips/v1/mapbox/driving/' + truck.location[0] + ',' + truck.location[1] + ';' + destinations.join(';') + '?overview=full&steps=true&geometries=geojson&source=first&access_token=' + mapboxgl.accessToken; 
        };

        function getRouteWeight(route){

            var destinations = [];
            route.forEach(function(Geometry){
                destinations.push(Geometry.geometry.coordinates); 
             }); 
            return 'https://api.mapbox.com/optimized-trips/v1/mapbox/driving/' + truck.location[0] + ',' + truck.location[1] + ';' + destinations.join(';') + '?overview=full&steps=true&geometries=geojson&source=first&access_token=' + mapboxgl.accessToken; 
        };
        
        // This function will get the information returned from the getRoute and use it to draw the optimized
        // truck route on the map.
        function drawRoute(){

            $.ajax({
              method: 'GET',
              url: getRouteMarked(markedDropoff),
            }).done(function(data) {
                  var route = (data.trips[0].geometry);
                  map.getSource('route').setData(route);
                  truck.updateRouteWeight(data.trips[0].duration);
            });
        };
        
        // This function will update the weight (re-appply the color) to the non-marked dropoff locations,
        // everytime a dropoff location is marked.
        function updateWeight(){
            var i = 0;
            var address = []
            dropoffLocations.features.forEach(function(drop){

                var copyMarked = markedDropoff.features.slice(0);
                copyMarked.push(drop)
                $.ajax({
                    method: 'GET',
                    url: getRouteWeight(copyMarked),
                    }).done(function(timeout) {

                        var newWeight = Math.round(timeout.trips[0].duration/60) - truck.routeWeight


                        drop.properties.weight = newWeight;

                        drop.properties.color = colorCalculator(drop.properties)
                    });
            });
            setTimeout(popupCreator, 2000);
        };

        // Creates a popup for every dropoff in dropoffLocations.
        function popupCreator(){
            popups.splice(0, popups.length);
            for(var i=0; i<dropoffLocations.features.length; i++){
                
                html= ''
                html+= 'name: '+dropoffLocations.features[i].properties.name+'<br>'
                html+= 'load: '+dropoffLocations.features[i].properties.load+' palletes<br>'
                html+= 'weight: '+dropoffLocations.features[i].properties.weight+ ' min'
                html+=  '<svg height="50" width="50"> <circle cx="25" cy="25" r="13" stroke="black" stroke-width="3" fill=' + dropoffLocations.features[i].properties.color + ' /></svg> '
                popups[i]= new mapboxgl.Popup();
                popups[i].setLngLat(dropoffLocations.features[i].geometry.coordinates)
                .setHTML(html)
                .addTo(map);
            }
        } 

        // Returns an integer between min(included) & max(excluded)
        function getRndInteger(min, max) {
            return Math.floor(Math.random() * (max - min) ) + min;
        }
        // *********************************************************************
        // Variable & Object Declaration
        // *********************************************************************

        // List which holds all the known dropoff locations on the map.
        var dropoffLocations= turf.featureCollection([
            turf.point([-66.0264859, 18.3939037],{name: '1',  load:1, weight:10}),
            turf.point([-66.0491875, 18.3912599],{name: '2',  load:2, weight:20}),
            turf.point([-66.0325626, 18.4221600],{name: '3',  load:3, weight:30}),
            turf.point([-66.0448384, 18.3801500],{name: '4',  load:4, weight:10}),
            turf.point([-66.0364162, 18.4249728],{name: '5',  load:2, weight:20}),
            turf.point([-66.0566923, 18.3949524],{name: '6',  load:3, weight:30}),
            turf.point([-66.0509650, 18.4134795],{name: '7',  load:1, weight:10}),
            turf.point([-66.0497187, 18.4151344],{name: '8',  load:2, weight:20}),
            turf.point([-66.0331616, 18.3826868],{name: '9',  load:3, weight:30}),
            turf.point([-66.0256296, 18.4088110],{name: '10', load:1, weight:10}),
            turf.point([-66.0674004, 18.3943928],{name: '11', load:2, weight:20}),
            turf.point([-66.0282124, 18.4057161],{name: '12', load:3, weight:30}),
            turf.point([-66.0463558, 18.4099867],{name: '13', load:1, weight:10}),
            turf.point([-66.0742350, 18.4124916],{name: '14', load:2, weight:20}),
            turf.point([-66.0522908, 18.3763833],{name: '15', load:3, weight:30}),
            turf.point([-66.0520926, 18.3784950],{name: '16', load:1, weight:10}),
            turf.point([-66.0637091, 18.4001899],{name: '17', load:2, weight:20}),
            turf.point([-66.0301777, 18.4094323],{name: '18', load:3, weight:30}),
            turf.point([-66.0471734, 18.3795232],{name: '19', load:1, weight:10}),
            turf.point([-66.0575418, 18.3975852],{name: '20', load:2, weight:20}),
            turf.point([-66.0376495, 18.4078695],{name: '21', load:3, weight:30}),
            turf.point([-66.0648457, 18.3842672],{name: '22', load:1, weight:10}),
            turf.point([-66.0714777, 18.3880810],{name: '23', load:2, weight:20}),
        ]);
        
        var blank = turf.featureCollection([]);
        var popups= [];
        // Empty list which will hold all the dropoff locations that were marked on the map.
        var markedDropoff = turf.featureCollection([]);
        
        //Object Truck
        var Truck = function(_location, _maxLoad, _model, _licensePlate, _trailer, _speed, _routeWeight, _expectedTime){
            this.location = _location;          //initial location of truck
            this.maxLoad = _maxLoad;            //maximum weight that truck can handle
            this.currentLoad = _maxLoad;        //current weight that truck is handling
            this.model = _model;                //model of truck
            this.licensePlate = _licensePlate;  //licence plate of truck
            this.trailer = _trailer;            //trailer model of truck
            this.speed = _speed;                //the speed of truck
            this.routeWeight = _routeWeight;    //time it takes the route to complete
            this.updateLoad = function(load){
                if((this.currentLoad - load) >= 0){
                    this.currentLoad = this.currentLoad - load;
                    
                }
                else{
                    alert('Not enought load in truck');
                }
            };
            this.updateRouteWeight = function(routeDurability){
                this.routeWeight = Math.round(routeDurability/60) //routeDurability will contain data.trips[0].duration which contains  
                                                                  // the time expected in seconds
            }
        };

        // *********************************************************************
        // Objects
        // *********************************************************************

        // initialize an object for the truck.
        var truck = new Truck([-66.0500, 18.4028], 30, 'Some Model', 'Pre-018', 'Some Trailer', 60, 0, 0)          
        updateWeight();

        // *********************************************************************
        // Mapbox 
        // *********************************************************************
        // Map Layers
        // *********************************************************************

        map.on('load', function(){
            // Add Truck.
            var marker = document.createElement('div');
            marker.classList = 'truck';

            // Create a new marker.
            truckMarker = new mapboxgl.Marker(marker)
            .setLngLat(truck.location)
            .addTo(map);

            // Adds layer with all dropoff locations.
            map.addLayer({
              id: 'dropoffs-symbol',
              type: 'symbol',
              source: {data: dropoffLocations,type: 'geojson'},
              layout: {
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-image': 'square-15',
              }
            });

            

            // Adds layer with all marked dropoff locations.
            map.addLayer({
              id: 'marked-dropoff',
              type: 'symbol',
              source: {data: markedDropoff,type: 'geojson'},
              layout: {
                'icon-allow-overlap': true,
                'icon-ignore-placement': true,
                'icon-image': 'circle-15',
              }
            });
            
            map.addSource('route', {
                type: 'geojson',
                data: blank
            });
            
            // Adds layer with the optimized truck route.
            map.addLayer({
              id:'route',
              type: 'line',
              source:'route',
              paint: {
                'line-color': '#0000ff',
                'line-width': 4
              }
            });
        });

        // Events/Listeners 
        // *********************************************************************
        map.on('click', e =>{

            // returns the info of the clicked dropoff marker on map.
            var pt = map.queryRenderedFeatures(e.point, {layers: ['dropoffs-symbol']});

            // if a marker is clicked, do the following
            if (pt.length){ 
                // looks for the clicked marker in dropoffLocations.
                for(var i = 0; i < dropoffLocations.features.length; i++){
                    // if the clicked marker is found, do the following.
                    if(pt[0].properties.name == dropoffLocations.features[i].properties.name){
                        // push the dropoff to markedDropoff.
                        markedDropoff.features.push(dropoffLocations.features[i]);
                        // update the truck load.
                        truck.updateLoad(dropoffLocations.features[i].properties.load);
                        // remove the dropoff from dropoffLocation, do to it now being marked.
                        dropoffLocations.features.splice(i, 1);
                    }  
                }

                // update the sources of the layers: 'dropoffs-symbol' & 'marked-dropoff'.
                map.getSource('dropoffs-symbol').setData(dropoffLocations);
                map.getSource('marked-dropoff').setData(markedDropoff);
                                
                // draw the truck route.
                drawRoute();

                // update the weight of the dropoff points in dropoffLocations.
                updateWeight();
            }   
        });
    </script>
</body>
</html>
