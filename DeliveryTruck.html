<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8' />
        <link rel="icon" href="PRoduce-logo.png">
        <title>Delivery truck</title>

        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
        <script src='scripts/HTML_tables.js'></script>
        <script src='scripts/Connections.js'></script>
        <script src='scripts/colorCalc_and_Randomizer.js'></script>
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>

        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet'/>
        <style>
            body {margin: 0; padding: 0;}

            tr:nth-child(even) {background-color: #dddddd;}

            table {
                font-family: arial, sans-serif;
                border-collapse: collapse;
                width: 100%;
            }

            td{
                border: 1px solid #dddddd;
                text-align: left;
                padding: 8px;
                cursor:context-menu;
            }

            th {
                border: 1px solid #dddddd;
                text-align: left;
                padding: 8px;
                cursor:pointer;
            }

            #map {
                position: absolute;
                top: 0;
                bottom: 0;
                right: 0;
                left: 0;
            }

            .truck {
                margin: -10px -10px;
                width: 20px;
                height: 20px;
                border: 2px solid #fff;
                border-radius: 50%;
                background: #3887BE;
                cursor: pointer;
            }

            .button {
               background-color: #4CAF50;
               border: none;
               color: white;
               padding: 15px 135px;
               text-align: center;
               text-decoration: none;
               display: inline-block;
               font-size: 16px;
               margin: 4px 2px;
               cursor: pointer;
            }

            .back {
                font-family: arial;
                border-collapse: collapse;
                width: 100%;
                padding: 20px 40px;
            }

            .mapboxgl-popup {max-width: 200px;}

            .mapboxgl-popup-content {
              text-align: center;
              font-family: 'Open Sans', sans-serif;
            }

            .map-overlay {
              position: absolute;
              bottom: 0;
              left: 0;
              background: rgba(255, 255, 255, 1.0);
              margin-left: auto;
              font-family: Arial, sans-serif;
              overflow: auto;
              border-radius: 3px;
            }

            #features {
              top: 0;
              height: 640px;
            }

            .previous {
                background-color: #f1f1f1;
                color: black;
            }

            .dot {
                height: 10px;
                width: 10px;
                background-color: #735139;
                border-radius: 50%;
                display: inline-block;
            }

            .legend {
                background-color: #fff;
                border-radius: 3px;
                bottom: 30px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.10);
                font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
                padding: 10px;
                position: absolute;
                right: 10px;
                z-index: 1;
            }

            .legend h4 {margin: 0 0 10px;}

            .legend div span {
                border-radius: 50%;
                display: inline-block;
                height: 15px;
                margin-right: 5px;
                width: 15px;
            }
        </style>
    </head>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
        <script type="text/javascript" src="../src/jquery.qrcode.js"></script>
        <script type="text/javascript" src="../src/qrcode.js"></script>

        <div id='marker-legend' class='legend'>
            <h4>Markers</h4>
            <div><span><svg width="10" height="10"><rect width="10" height="10" style="fill:#735139" /></svg></span>Unmarked Dropoff</div>
            <div><span><svg width="10" height="10"><circle cx="5" cy="5" r="5" style="fill:#735139"  /></svg></span>Marked Dropoff</div>
            <div><span><svg width="10" height="10"><circle cx="5" cy="5" r="5" style="fill:#3887BE"  /></svg></span>Truck</div>
        </div>

        <div id='map' class='contain'> </div>
        <div class='map-overlay' id='features'>
        <div id='pd'></div></div>
        <script type="text/javascript">
            // *********************************************************************
            // TODO
            // *********************************************************************
            // - Solves problem with radius that creates popups with negative times.
            // - Make the UI more intituive.
            // - Adding legend for marked dropoff, dropoff location
            // - Make route box have a clickable pointer to help user on how the porgram works
            // *********************************************************************
            // Mapbox
            // *********************************************************************

            // Load initial map
            // *********************************************************************
            mapboxgl.accessToken = 'pk.eyJ1IjoidG9ybGFuY28iLCJhIjoiY2prYmR3dmszMHVtcDNwbWl3cHdwOTl5NSJ9.NxympEZmljc0jq4DJmK5JQ';

            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/streets-v10', // stylesheet location
                // style: 'mapbox://styles/mapbox/light-v9', // stylesheet location
                center: [-66.700, 18.2208], // starting position
                zoom: 8.5 // starting zoom
            });

            // Navigation Control
            var nav = new mapboxgl.NavigationControl();
            map.addControl(nav, 'top-right');

            // *********************************************************************
            // Variable & Object Declaration
            // *********************************************************************

            // List which holds all the known dropoff locations on the map.
            // var numberOfRoutes= prompt("Please enter the number of routes to be made", 3);
            // while(numberOfRoutes<1){numberOfRoutes= prompt("Please enter the number of routes to be made", 1);}
            var numberOfRoutes= 5;
            var dropcoor = turf.featureCollection([]);
            var dropoffLocations= turf.featureCollection([]);
            var dropoffPopup = turf.featureCollection([]);
            var blank = turf.featureCollection([]);
            var popups= [];
            var trucks = [];
            var popuproute;
            var truckSelected;
            var hoverPopup = new mapboxgl.Popup({ offset: [-1, -7], closeButton:false});
            var HTML_Table = '<table>'
            var id=1;
            var AutoColors= ['#ff0000', '#ff8000', '#ffff00',
                             '#00ff00', '#00ffff', '#0000ff',
                             '#ff00ff', '#808080', '#99004c'];

            var Truck = function(_location, _maxLoad, _routeColor){
                this.id=id++;                       //id of truck
                this.location = _location;          //initial location of truck
                this.maxLoad = _maxLoad;            //maximum weight that truck can handle
                this.currentLoad = _maxLoad;        //current weight that truck is handling
                this.routeWeight = 0;               //time it takes the route to complete
                this.markedDropoff = turf.featureCollection([]);
                this.waypoints = [];
                this.route=[];
                this.marker = document.createElement('div');
                this.marker.classList = 'truck';
                this.routeMile;
                this.color= _routeColor
                this.routeColor= {'line-color':this.color , 'line-width':4};;

                this.truckMarker = new mapboxgl.Marker(this.marker)
                   .setLngLat(this.location)
                   .addTo(map);

                this.updateLoad = load => {
                    if((this.currentLoad - load) >= 0){this.currentLoad = this.currentLoad - load;}
                    else{alert('Not enought load in truck');}
                };

                this.freeLoad= load =>{this.currentLoad= this.currentLoad + load;}

                this.updateRouteWeight = function(routeDurability){
                    // routeDurability will contain data.trips[0].duration which contains
                    // the time expected in seconds
                    this.routeWeight = Math.round(routeDurability/60)

                }
            };

            // *********************************************************************
            // Functions Declaration
            // *********************************************************************

            // When Selecting a truck, this will be the menu that will display. It displays information about the route that was selected(soon directions of the route)

            // This function will get the information returned from the getRoute and use it to draw the optimized
            // truck route on the map.

            function allRoute(){
                var allMarkedDropoff = turf.featureCollection([]);
                trucks.forEach(truck => {
                    // map.setLayoutProperty('route'+truck.id, 'visibility', "visible");
                    map.setPaintProperty('route'+truck.id, 'line-opacity', 1)
                    truck.markedDropoff.features.forEach(md  =>{
                        allMarkedDropoff.features.push(md);
                    })
                })
                map.getSource('unmarked-dropoff').setData(dropoffLocations);
                map.getSource('marked-dropoff' ).setData(allMarkedDropoff);
            }

            // This functions calls the optimization api to calculate the time that will add to each dropoff
            function updateTruckWeight(drop, truck, hover){
                var copyMarked = truck.markedDropoff.features.slice(0);
                copyMarked.push(drop)
                fetch(getRouteWeight(copyMarked, truck, mapboxgl.accessToken))
                .then(res =>{
                    return res.json();
                })
                .then(data =>{
                    var newWeight = Math.round(data.trips[0].duration/60) - truck.routeWeight;
                    drop.properties.weight = newWeight;
                    drop.properties.color = colorCalculator(drop.properties)
                    return drop
                })
                .then(feature =>{

                    createPopup(feature, hover);
                    dropoffLocations.features.forEach(function(dropoff){
                        if(dropoff.properties.name == feature.properties.name){
                            dropoff.properties.weight = feature.properties.weight
                        }
                    map.getSource('unmarked-dropoff').setData(dropoffLocations)
                    })
                })
            };

            // Function that is called when the Add Route Button is added. For now it adds a marker to the
            // map within a bounding box. and create a truck object.
            function AddRoute(){
                var location = document.getElementById('location').value;
                location = location.split(",")
                var x = parseFloat(location[0])
                var y = parseFloat(location[1])

                var RouteColor = document.getElementById('RouteColor').value;
                var MaxLoad = document.getElementById('MaxLoad').value;

                var tmp= new Truck([x, y], MaxLoad, RouteColor);
                trucks.push(tmp);
                map.addLayer({
                  id:'route'+tmp.id,
                  type: 'line',
                  source:{data: blank,type: 'geojson'},
                  paint: tmp.routeColor
                }, 'unmarked-dropoff');

                map.on('mouseover', 'route'+tmp.id, e => {

                    // check is cursor is hovering over route
                    var routeLocation =  map.queryRenderedFeatures(e.point, {layers: ['route'+tmp.id]});
                    // if hovering on route, create route popup
                    if (routeLocation.length){
                        var pophtml = ''
                        pophtml+= 'Route '+ tmp.id +' Duration<br>'
                        pophtml+= tmp.routeWeight+ ' min' //Think of how to get the correct truck of the route selected.
                        popuproute = new mapboxgl.Popup({ offset: [0, -15], closeButton:false})
                            .setLngLat(e.lngLat)
                            .setHTML(pophtml)
                            .addTo(map);
                    }
                });

                // when the cursor leaves the route, removes route popup.
                map.on('mouseleave', 'route'+tmp.id, e => {popuproute.remove();});
                HTMLTable(trucks, map);
            }

            function AutoAddRoute(){
                // var location = document.getElementById('location').value;
                // location = location.split(",");
                var location= [-66.06988906860352, 18.44834670293207];
                var x = parseFloat(location[0]);
                var y = parseFloat(location[1]);

                var RouteColor = AutoColors.shift();
                var MaxLoad = 200;

                var tmp= new Truck([x, y], MaxLoad, RouteColor);
                trucks.push(tmp);
                map.addLayer({
                  id:'route'+tmp.id,
                  type: 'line',
                  source:{data: blank,type: 'geojson'},
                  paint: tmp.routeColor
                }, 'unmarked-dropoff');

                map.on('mouseover', 'route'+tmp.id, e => {

                    // check is cursor is hovering over route
                    var routeLocation =  map.queryRenderedFeatures(e.point, {layers: ['route'+tmp.id]});
                    // if hovering on route, create route popup
                    if (routeLocation.length){
                        var pophtml = ''
                        pophtml+= 'Route '+ tmp.id +' Duration<br>'
                        pophtml+= tmp.routeWeight+ ' min' //Think of how to get the correct truck of the route selected.
                        popuproute = new mapboxgl.Popup({ offset: [0, -15], closeButton:false})
                            .setLngLat(e.lngLat)
                            .setHTML(pophtml)
                            .addTo(map);
                    }
                });

                // when the cursor leaves the route, removes route popup.
                map.on('mouseleave', 'route'+tmp.id, e => {popuproute.remove();});
                HTMLTable(trucks, map);
            }

            function removeRoute(){
                map.removeLayer('route'+truckSelected.id);
                map.removeSource('route'+truckSelected.id);
                while(truckSelected.route.length>0){
                    dropoffLocations.push(truckSelected.route[0]);
                    truckSelected.route.splice(0,1);
                }
                for(var i=0; i<trucks.length; i++){
                    if(trucks[i].id==truckSelected.id){
                        trucks[i].truckMarker.remove();
                        trucks.splice(i, 1);
                        break;
                    }
                }
                map.getSource('unmarked-dropoff').setData(dropoffLocations);
                map.getSource('marked-dropoff').setData(blank);
                HTMLTable(trucks, map);
            }

            function SelectTruck(id){

                trucks.forEach(truck => {

                    if(truck == trucks[id]){
                        truckSelected = trucks[id]
                        map.setPaintProperty('route'+truckSelected.id, 'line-opacity', 1)
                    }
                    else{
                    truck.truckMarker.remove()
                    map.setPaintProperty('route'+truck.id, 'line-opacity', 0.3)
                    }
                })
                map.getSource('marked-dropoff').setData(truckSelected.markedDropoff)
                HTMLDirections(truckSelected, id, trucks, map)
                // Radius(truckSelected.location[0],truckSelected.location[1],truckSelected)
            }

            // Display automatically the popups of the dropoff within the Radius
            function Radius(_x, _y, truck){

                var centerPoint = {radius:0.16093, x:_x, y:_y}
                dropoffLocations.features.forEach(point =>{
                    var pointLocation = {radius: 0.00001, x:point.geometry.coordinates[0], y:point.geometry.coordinates[1]}
                    var dx = centerPoint.x - pointLocation.x;
                    var dy = centerPoint.y - pointLocation.y;
                    if(Math.sqrt(dx*dx + dy*dy) < centerPoint.radius){
                        dropoffPopup.features.push(point)
                        new updateTruckWeight(point, truck, false)
                    }
                })
            };

            // if feature.weight == -1 || feature.weight < dropoff.weight
            // Creates a popup for every dropoff in dropoffLocations.
            function createPopup(feature, hover){
                html= ''
                // html+= feature.properties.load+' palletes<br>'
                html+= feature.properties.name+'<br>'
                html+= '<svg height=15 width=20 xmlns="http://www.w3.org/2000/svg" version="1.1">'
                html+= '<circle cx="10" cy="10" r="5" fill="'+feature.properties.color+'"/></svg>'
                html+= '+'+feature.properties.weight+ ' min'
                html+= '<div> Cluster: ' + feature.properties.cluster + '<div>'
                if(hover){
                    hoverPopup.setHTML(html)
                    .setLngLat(feature.geometry.coordinates)
                    .addTo(map);
                }
                else{
                    var popup = new mapboxgl.Popup({ offset: [-1, -7], closeButton:false})
                        //.setLngLat(feature.geometry.coordinates)
                        .setHTML(html)
                        .setLngLat(feature.geometry.coordinates)
                        .addTo(map);
                    setTimeout(function(){popup.remove()}, 5000)
                }
            };

            function AutoAddRoute(){
                // var location = document.getElementById('location').value;
                // location = location.split(",");
                var location= [-66.06988906860352, 18.44834670293207];
                var x = parseFloat(location[0]);
                var y = parseFloat(location[1]);

                var RouteColor = AutoColors.shift();
                var MaxLoad = 200;

                var tmp= new Truck([x, y], MaxLoad, RouteColor);
                trucks.push(tmp);
                map.addLayer({
                  id:'route'+tmp.id,
                  type: 'line',
                  source:{data: blank,type: 'geojson'},
                  paint: tmp.routeColor
                }, 'unmarked-dropoff');

                map.on('mouseover', 'route'+tmp.id, e => {

                    // check is cursor is hovering over route
                    var routeLocation =  map.queryRenderedFeatures(e.point, {layers: ['route'+tmp.id]});
                    // if hovering on route, create route popup
                    if (routeLocation.length){
                        var pophtml = ''
                        pophtml+= 'Route '+ tmp.id +' Duration<br>'
                        pophtml+= tmp.routeWeight+ ' min' //Think of how to get the correct truck of the route selected.
                        popuproute = new mapboxgl.Popup({ offset: [0, -15], closeButton:false})
                            .setLngLat(e.lngLat)
                            .setHTML(pophtml)
                            .addTo(map);
                    }
                });

                // when the cursor leaves the route, removes route popup.
                map.on('mouseleave', 'route'+tmp.id, e => {popuproute.remove();});
                HTMLTable(trucks, map);
            }

            function AutoSelectTruck(id){

                trucks.forEach(truck => {

                    if(truck == trucks[id]){
                        truckSelected = trucks[id]
                        map.setPaintProperty('route'+truckSelected.id, 'line-opacity', 1)
                    }
                    else{
                    truck.truckMarker.remove()
                    map.setPaintProperty('route'+truck.id, 'line-opacity', 0.3)
                    }
                })
                // map.getSource('marked-dropoff').setData(truckSelected.markedDropoff)
                // HTMLDirections(truckSelected, id, trucks, map)
                // Radius(truckSelected.location[0],truckSelected.location[1],truckSelected)
            }

            dropoffLocations.features.push(turf.point([-66.7644010,18.429039],
                {name:'Delmaris Santiago Sierra', telephone:'(787)-235-2823', 
                 address:'hacienda toledo casa g286 Arecibo 00612', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0685340,18.419851],
                {name:'Leticia Diaz', telephone:'(787)-360-4488', 
                 address:'Calle Soldado Ulises Arrigoitia 466, San Juan, Puerto Rico Urb Roosevelt 00918', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.2703290,18.475018],
                {name:'Valerie Alvarado', telephone:'(787)-525-4931', 
                 address:'Villas de Golf, 21 villa este, Dorado, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0556480,18.402492],
                {name:'Iris Cosme Gomez', telephone:'(787)-627-6552', 
                 address:'Cond Santa Rita  997  calle Córdova Dávila Apto A-803 San Juan, PR 00925', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0933620,18.383579],
                {name:'Primitivo Perez Beniquez', telephone:'(787)-948-4787', 
                 address:'1800 Calle San Gregorio Apt 210, San Juan, Puerto Rico 00921', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0647070,18.455026],
                {name:'Myrna Santana', telephone:'(787)-761-0338', 
                 address:'Torre del Mar 6-A, Ashford Avenue, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0676360,18.453452],
                {name:'Jorge Gonzalez', telephone:'(787)-509-1270', 
                 address:'1373 Calle Luchetti, Apt 302, San Juan, Puerto Rico 00907', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0910350,18.410858],
                {name:'Carolyn Ferrandino', telephone:'(787)-617-6685', 
                 address:'419 Calle Darién, San Juan, Puerto Rico 00920', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1413240,18.388449],
                {name:'Zayrah Silva', telephone:'(787)-242-4120 / 7877635050', 
                 address:'55-11 Calle Boundary, Ubr Santa Rosa', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1236040,18.391821],
                {name:'Zayra Lopez', telephone:'(787)-396-3333', 
                 address:'Valles de Torrimar Apto. i-109 Guaynabo, Puerto Rico 00966', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0731630,18.455672],
                {name:'Francisco Jimenez', telephone:'(787)-379-4731', 
                 address:'1155 Avenida Magdalena, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0645310,18.405604],
                {name:'Leopoldo Czeplo', telephone:'(787)-475-2033', 
                 address:'277 Calle Fordham, San Juan', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-65.9483510,18.248085],
                {name:'Juan J Figueroa', telephone:'(787)-361-7442', 
                 address:'Calle albahaca 135 Ciudad jardin Gurabo PR, 00778-9666', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0274730,18.443936],
                {name:'Laura Tirado', telephone:'(787)-366-7229', 
                 address:'4745 Avenida Isla Verde, Carolina, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1932780,18.438267],
                {name:'Belén Resto', telephone:'(787)-261-4792', 
                 address:'Ms32 calle arcoíris mansión del sol Toa Baja pr 00949', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0424210,18.373087],
                {name:'Mariana Zepeda Guerrero', telephone:'(787)-960-3863', 
                 address:'Condominio Pórticos de Cupey apt H101 San Juan PR', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0527800,18.359152],
                {name:'Milimar Landron', telephone:'(787)-403-2238', 
                 address:'311 Calle Teresa Jornet Tropical Courts 1303', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0596180,18.409570],
                {name:'Brenda Ayala', telephone:'(787)-634-1804', 
                 address:'145 Avenida Hostos Apt. G-613, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1252400,18.368986],
                {name:'Alan Wagner', telephone:'(787)-236-9366', 
                 address:'39 Calle Raphis, Urbanización Palma Real, Guaynabo, 00969, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1709810,18.435741],
                {name:'Betty Rodriguez', telephone:'(787)-666-8705', 
                 address:'Hg 19 Monsita Ferrer 7ma secc Levittown Toa Baja, Puerto Rico 00949', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0670414,18.382139],
                {name:'Doriliana Rivera', telephone:'(787)-410-1017', 
                 address:'140 Calle Guadalquivir, Urb. El Paraiso, San Juan PR 00926', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0727820,18.450207],
                {name:'Edward Betancourt', telephone:'(617)-308-5742', 
                 address:'305 Calle Villamil, Apt 1807, San Juan PR', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0595970,18.409590],
                {name:'Francisco Tirado', telephone:'(787)-425-1555', 
                 address:'145 Ave. Hostos Apt. G405 San Juan PR 00918', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0158750,18.445390],
                {name:'Gabriela de la Vega', telephone:'(787)-645-9537', 
                 address:'14  Calle Amapola Apt 1201 Carolina, PR 00979', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0624190,18.454377],
                {name:'Johanna Torres', telephone:'(787)-455-7305', 
                 address:'1510 Ashford Avenues, Ashford Plaza, Apt 2E, San Juan, Puerto Rico ', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1024470,18.372744],
                {name:'Roberto C. Rodríguez', telephone:'(787)-516-7960', 
                 address:'39 Calle Escarlata, Guaynabo, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.2353010,18.422909],
                {name:'Luz N Marrero', telephone:'(787)-688-9061', 
                 address:'Urb. Valparaiso Calle 3 K 48, Toa Baja , PR', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0609150,18.302800],
                {name:'Mabel Varela', telephone:'(787)-579-1557', 
                 address:'Urb Laderas de San Juan 83 calle ortegon San Juan PR, 00926', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1065740,18.398008],
                {name:'Marie Custodio', telephone:'(787)-512-1045', 
                 address:'Urb. Altamira calle Sirio 512 San Juan, Puerto Rico 00920 ', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0580340,18.366160],
                {name:'Marta Figueroa', telephone:'(787)-647-3509', 
                 address:'Calle 7 C1 Sierra del Río San Juan, Puerto Rico 00926', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1279900,18.367535],
                {name:'Michelle Coll', telephone:'(787)-914-1037', 
                 address:'83 Viajera, Palma Real, Guaynabo, PR 00969', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0655610,18.446211],
                {name:'Nicolette Rae Johnson', telephone:'(651)-332-0441', 
                 address:'352 Calle del Parque #610, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0216390,18.440716],
                {name:'Raven J Sandifer', telephone:'(312)-316-4637', 
                 address:'5894 Calle Jose M. Tartak Torre C Apt.508C, Carolina, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0029940,18.254485],
                {name:'Sandra Catalá', telephone:'(787)-310-8152', 
                 address:'23 Calle Canaria, Urb. Estancias de Santa Bárbara, Gurabo PR 00778', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0640460,18.449701],
                {name:'Tyler Martin', telephone:'(415)-218-7667', 
                 address:'1554 Calle Lopez Landron Apt PH504', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0825860,18.453455],
                {name:'Vivianna ramirez de arellano', telephone:'(787)-399-0621', 
                 address:'655 Calle La Paz, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0557270,18.405431],
                {name:'Waldin Vázquez Pagán', telephone:'(787)-235-4814', 
                 address:'862 Calle Esteban González, Apt. 9-A, San Juan, Puerto Rico 00925', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.1048120,18.383766],
                {name:'Miriam Gonzalez', telephone:'(787)-396-1672', 
                 address:'Urbanizacion Sevilla Biltmore F 41 Guaynabo, Puerto Rico ', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-67.1867780,18.399575],
                {name:'Audrey Binkowski', telephone:'(845)-820-5469', 
                 address:'Carretera 441 Km 2.6 Interior Playa', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0087290,18.389582],
                {name:'Orlando Ruiz Rivera', telephone:'(787)-455-3158', 
                 address:'Z1-6 calle 18St  MonteCarlo San Juan 00924-5828', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-65.9732590,18.425560],
                {name:'Denise Cuevas', telephone:'(787)-360-3494', 
                 address:'CH-10 Calle 143, Jardines de Country Club, Carolina PR 00983', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0684340,18.454431],
                {name:'Catherine Aguilar Ramos', telephone:'(787)-464-6729', 
                 address:'1357 Avenida Magdalena Edificio Santa Genoveva Apt 3B, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0933300,18.464157],
                {name:'Maria E Rodríguez', telephone:'(787)-667-8343', 
                 address:'450 Ave Constitucion Apt 11A, San Juan, PR 00901', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0614710,18.453000],
                {name:'Jackie Markot', telephone:'(646)-944-5744', 
                 address:'76 Calle Kings Court, 504, San Juan, Puerto Rico', weight:-1, load:1, ppop:false}));
            dropoffLocations.features.push(turf.point([-66.0667860,18.431588],
                {name:'Jose Ricardo', telephone:'(787)-614-1847', 
                 address:'151 calle cesar gonzalez condominio plaza antillana apt 1103', weight:-1, load:1, ppop:false}));

            var KmeansPoints = turf.featureCollection([]);
            dropoffLocations.features.forEach(drop =>{
                KmeansPoints.features.push(turf.point(drop.geometry.coordinates))
            })
            var Kmeans = turf.clustersKmeans(KmeansPoints, {numberOfClusters: numberOfRoutes});

            Kmeans.features.forEach(point => {
                for(var i = 0; i < dropoffLocations.features.length; i++){
                    if(point.geometry.coordinates[0] == dropoffLocations.features[i].geometry.coordinates[0] &&
                       point.geometry.coordinates[1] == dropoffLocations.features[i].geometry.coordinates[1]){
                            dropoffLocations.features[i].properties.cluster = point.properties.cluster
                            break;
                    }
                }
            })

            var clustersSize= new Array(numberOfRoutes+1).join('0').split('').map(parseFloat);
            for (var i=0; i<dropoffLocations.features.length; i++){
                clustersSize[dropoffLocations.features[i].properties.cluster]+=1};

            while(Math.max(...clustersSize)>10){
                numberOfRoutes= numberOfRoutes+1;
                var KmeansPoints = turf.featureCollection([]);
                dropoffLocations.features.forEach(drop =>{
                    KmeansPoints.features.push(turf.point(drop.geometry.coordinates))
                })
                var Kmeans = turf.clustersKmeans(KmeansPoints, {numberOfClusters: numberOfRoutes});

                Kmeans.features.forEach(point => {
                    for(var i = 0; i < dropoffLocations.features.length; i++){
                        if(point.geometry.coordinates[0] == dropoffLocations.features[i].geometry.coordinates[0] &&
                           point.geometry.coordinates[1] == dropoffLocations.features[i].geometry.coordinates[1]){
                                dropoffLocations.features[i].properties.cluster = point.properties.cluster
                                break;
                        }
                    }
                })

                var clustersSize= new Array(numberOfRoutes+1).join('0').split('').map(parseFloat);
                for (var i=0; i<dropoffLocations.features.length; i++){
                    clustersSize[dropoffLocations.features[i].properties.cluster]+=1};
            }
            console.log(clustersSize);
            // *********************************************************************
            // Mapbox
            // *********************************************************************
            // Map Layers
            map.on('load', function(){

                // Adds layer with all dropoff locations.
                map.addLayer({
                  id: 'unmarked-dropoff',
                  type: 'symbol',
                  source: {data: dropoffLocations,type: 'geojson'},
                  layout: {
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true,
                    'icon-image': 'square-15',
                  }
                });

                // Adds layer with all marked dropoff locations.
                map.addLayer({
                  id: 'marked-dropoff',
                  type: 'symbol',
                  source: {data: blank,type: 'geojson'},
                  layout: {
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true,
                    'icon-image': 'circle-15',
                  }
                });

                // var size=numberOfRoutes;
                // for(var i=0; i<numberOfRoutes; i++){
                //     AutoAddRoute();
                //     AutoSelectTruck(i);
                //     var cluster= clustersSize.indexOf(Math.max(...clustersSize));
                //     for (var j=0; j<dropoffLocations.features.length; j++){
                //         if (dropoffLocations.features[j].properties.cluster == cluster){
                //             truckSelected.markedDropoff.features.push(dropoffLocations.features[j]);
                //             truckSelected.updateLoad(dropoffLocations.features[j].properties.load);
                //             dropoffLocations.features.splice(j, 1);
                //             if (j>0){j=j-1;}
                //             else if(j==0 && dropoffLocations.features.length>0){j=-1;}

                //             if(dropoffLocations.features.length==0){break;}
                //             else if(truckSelected.markedDropoff.features.length==10 || truckSelected.markedDropoff.features.length==Math.max(...clustersSize)){

                //                     KmeansPoints = turf.featureCollection([]);
                //                     dropoffLocations.features.forEach(drop =>{
                //                         KmeansPoints.features.push(turf.point(drop.geometry.coordinates))
                //                     })

                //                     if(size-1==0){size=Math.sqrt(numberOfPoints/2)}
                //                     else{size-=1;}
                //                     Kmeans = turf.clustersKmeans(KmeansPoints, {numberOfClusters: size})
                //                     Kmeans.features.forEach(point => {
                //                         for(var x = 0; x < dropoffLocations.features.length; x++){
                //                             if(point.geometry.coordinates[0] == dropoffLocations.features[x].geometry.coordinates[0] &&
                //                                point.geometry.coordinates[1] == dropoffLocations.features[x].geometry.coordinates[1]){
                //                                     dropoffLocations.features[x].properties.cluster = point.properties.cluster
                //                                     break;
                //                             }
                //                         }
                //                     })

                //                     clustersSize= new Array(size+1).join('0').split('').map(parseFloat);
                //                     for (var y=0; y<dropoffLocations.features.length; y++){
                //                         clustersSize[dropoffLocations.features[y].properties.cluster]+=1};
                //                     break;
                //             }
                //         }

                //     }
                //     AutoDrawRoute(truckSelected, trucks, map, mapboxgl.accessToken);
                // }

                HTMLTable(trucks, map);

            });

            // *********************************************************************
            // Events/Listeners

            // when the clicks on the map, checks if a marker was clicked and if true,
            // then change that marker from unmarked to marked or vice-versa.
            map.on('click',e =>{
                // returns the info of the clicked dropoff marker on map.
                var pt = map.queryRenderedFeatures(e.point, {layers: ['unmarked-dropoff', 'marked-dropoff']});
                if(pt.length && trucks.length==0){
                    alert('Please add a route first by clicking "Add Route" located on the left of the screen.')
                }
                else if(pt.length && truckSelected == undefined){
                    alert('Please select a route before adding a dropoff.\nSelect the route you want to interact with by clicking the Route.')
                }
                // if a marker is clicked, do the following
                if (pt.length){
                    // if the marker is unmarked, do the following
                    if(pt[0].layer.id=='unmarked-dropoff'){
                        // looks for the clicked marker in dropoffLocations.
                        for(var i = 0; i < dropoffLocations.features.length; i++){
                            // if the clicked marker is found, do the following.
                            if(pt[0].properties.name == dropoffLocations.features[i].properties.name){
                                // push the dropoff to markedDropoff.
                                truckSelected.markedDropoff.features.push(dropoffLocations.features[i]);
                                // update the truck load.
                                truckSelected.updateLoad(dropoffLocations.features[i].properties.load);
                                // remove the dropoff from dropoffLocation, do to it now being marked.
                                dropoffLocations.features.splice(i, 1);
                                break;
                            }
                            dropoffLocations.features[i].properties.weight = -1;
                        }
                    }

                    // if the marker is marked, do the following
                    else{
                        // look the marker in markedDropoff of truckSelected
                        for(var i=0; i<truckSelected.markedDropoff.features.length; i++){
                            // if found, do the following
                            if(pt[0].properties.name == truckSelected.markedDropoff.features[i].properties.name){
                                // check if marked is already in dropoffLocations.
                                var check=0;
                                for(var j=0; j<dropoffLocations.features.length; j++){
                                    if(pt[0].properties.name == dropoffLocations.features[j].properties.name){
                                        check=1;
                                        break;
                                    }
                                }

                                // if the marked is not in dropoffLocations, then add it
                                if(check==0){dropoffLocations.features.push(pt[0])};

                                // update truckSelected
                                truckSelected.freeLoad(pt[0].properties.load);

                                // remove the dropoff from truckSelected.markedDropoff
                                truckSelected.markedDropoff.features.splice(i, 1);
                                break;
                            }
                        }
                    }
                }

                // if marker not clicked, change ppop of dropoffLocations to false.
                else{
                    for (var i=0; i< dropoffLocations.features.length; i++){
                        dropoffLocations.features[i].properties.ppop=false;
                    }
                }

                // update the sources of the layers: 'unmarked-dropoff' & 'marked-dropoff'.
                map.getSource('unmarked-dropoff').setData(dropoffLocations);


                if(truckSelected!=undefined){
                    map.getSource('marked-dropoff').setData(truckSelected.markedDropoff);
                    drawRoute(truckSelected, trucks, map, mapboxgl.accessToken);

                    //update the weight of the dropoff points in dropoffLocations.
                    dropcoor.features.length = 0

                    dropcoor.features.push(turf.point([truckSelected.location[0], truckSelected.location[1]]))
                    truckSelected.markedDropoff.features.forEach(mark => {
                         dropcoor.features.push(turf.point(mark.geometry.coordinates))
                    })
                    var center = turf.center(dropcoor)

                    // Uncomment the line below to use the radius function
                    // Radius(center.geometry.coordinates[0], center.geometry.coordinates[1], truckSelected);
                }
            });

            // when the cursor is hovering over the marker, it will change the cursor icon
            // from the grab icon to the pointer icon & create a popup for the dropoff marker.

            map.on('mouseover', 'unmarked-dropoff', e=> {
                var features = map.queryRenderedFeatures(e.point, {layers: ['unmarked-dropoff']});
                // if cursor hovers an unmarked dropoff, do the following
                if (features.length && truckSelected!=undefined) {

                    map.getCanvas().style.cursor='pointer'; // change cursor icon from grab to pointer

                    feature=features[0];

                    // if weight of dropoff is undefined, update it
                    if(feature.properties.weight == -1){
                        updateTruckWeight(feature, truckSelected, true);
                    }

                    // if the dropoff does not have a popup, do the following
                    else {
                        feature.properties.color= colorCalculator(feature.properties) // update color of dropoff


                        createPopup(feature, true);   //create popup for dropoff
                        //feature.properties.ppop=true; //change ppop of dropoff

                        // update dropoff in dropoffLocations
                        for (var i=0; i<dropoffLocations.features.length; i++){
                            if(feature.properties.name==dropoffLocations.features[i].properties.name){
                                dropoffLocations.features[i]= feature;
                                break
                            }
                        }

                        // update source of the layer 'unmarked-dropoff'.
                        map.getSource('unmarked-dropoff').setData(dropoffLocations);
                    }
                }
                if(features.length){map.getCanvas().style.cursor='pointer'};
            });

            map.on('mouseleave','unmarked-dropoff', e=> {setTimeout(function(){hoverPopup.remove();}, 3000);})

            // when the cursor is hovering over the marker, it will change the cursor icon
            // from the grab icon to the pointer icon.
            map.on('mouseover', 'marked-dropoff' , e=>{
                features= map.queryRenderedFeatures(e.point, {layers:['marked-dropoff']});
                if(features.length && truckSelected != undefined){map.getCanvas().style.cursor='pointer'};
            })

            // when the cursor leaves the marker, change cursor icon from the pointer icon
            // to the grab icon.
            map.on('mouseleave','unmarked-dropoff', e=> {map.getCanvas().style.cursor=''});

            // when the cursor leaves the marker, change cursor icon from the pointer icon
            // to the grab icon.
            map.on('mouseleave','marked-dropoff' , e=> {map.getCanvas().style.cursor=''});

        </script>
    </body>
</html>
